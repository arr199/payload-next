"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "buildSearchParam", {
    enumerable: true,
    get: function() {
        return buildSearchParam;
    }
});
const _bsonobjectid = /*#__PURE__*/ _interop_require_default(require("bson-objectid"));
const _mongoose = /*#__PURE__*/ _interop_require_default(require("mongoose"));
const _database = require("payload/database");
const _types = require("payload/types");
const _operatorMap = require("./operatorMap");
const _sanitizeQueryValue = require("./sanitizeQueryValue");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const subQueryOptions = {
    lean: true,
    limit: 50
};
async function buildSearchParam({ collectionSlug, fields, globalSlug, incomingPath, locale, operator, payload, val }) {
    // Replace GraphQL nested field double underscore formatting
    let sanitizedPath = incomingPath.replace(/__/g, '.');
    if (sanitizedPath === 'id') sanitizedPath = '_id';
    let paths = [];
    let hasCustomID = false;
    if (sanitizedPath === '_id') {
        const customIDfield = payload.collections[collectionSlug]?.config.fields.find((field)=>(0, _types.fieldAffectsData)(field) && field.name === 'id');
        let idFieldType = 'text';
        if (customIDfield) {
            if (customIDfield?.type === 'text' || customIDfield?.type === 'number') {
                idFieldType = customIDfield.type;
            }
            hasCustomID = true;
        }
        paths.push({
            collectionSlug,
            complete: true,
            field: {
                name: 'id',
                type: idFieldType
            },
            path: '_id'
        });
    } else {
        paths = await (0, _database.getLocalizedPaths)({
            collectionSlug,
            fields,
            globalSlug,
            incomingPath: sanitizedPath,
            locale,
            payload
        });
    }
    const [{ field, path }] = paths;
    if (path) {
        const { operator: formattedOperator, val: formattedValue } = (0, _sanitizeQueryValue.sanitizeQueryValue)({
            field,
            hasCustomID,
            operator,
            path,
            val
        });
        // If there are multiple collections to search through,
        // Recursively build up a list of query constraints
        if (paths.length > 1) {
            // Remove top collection and reverse array
            // to work backwards from top
            const pathsToQuery = paths.slice(1).reverse();
            const initialRelationshipQuery = {
                value: {}
            };
            const relationshipQuery = await pathsToQuery.reduce(async (priorQuery, { collectionSlug: slug, path: subPath }, i)=>{
                const priorQueryResult = await priorQuery;
                const SubModel = payload.db.collections[slug];
                // On the "deepest" collection,
                // Search on the value passed through the query
                if (i === 0) {
                    const subQuery = await SubModel.buildQuery({
                        locale,
                        payload,
                        where: {
                            [subPath]: {
                                [formattedOperator]: val
                            }
                        }
                    });
                    const result = await SubModel.find(subQuery, subQueryOptions);
                    const $in = [];
                    result.forEach((doc)=>{
                        const stringID = doc._id.toString();
                        $in.push(stringID);
                        if (_mongoose.default.Types.ObjectId.isValid(stringID)) {
                            $in.push(doc._id);
                        }
                    });
                    if (pathsToQuery.length === 1) {
                        return {
                            path,
                            value: {
                                $in
                            }
                        };
                    }
                    const nextSubPath = pathsToQuery[i + 1].path;
                    return {
                        value: {
                            [nextSubPath]: {
                                $in
                            }
                        }
                    };
                }
                const subQuery = priorQueryResult.value;
                const result = await SubModel.find(subQuery, subQueryOptions);
                const $in = result.map((doc)=>doc._id.toString());
                // If it is the last recursion
                // then pass through the search param
                if (i + 1 === pathsToQuery.length) {
                    return {
                        path,
                        value: {
                            $in
                        }
                    };
                }
                return {
                    value: {
                        _id: {
                            $in
                        }
                    }
                };
            }, Promise.resolve(initialRelationshipQuery));
            return relationshipQuery;
        }
        if (formattedOperator && _types.validOperators.includes(formattedOperator)) {
            const operatorKey = _operatorMap.operatorMap[formattedOperator];
            if (field.type === 'relationship' || field.type === 'upload') {
                let hasNumberIDRelation;
                const result = {
                    value: {
                        $or: [
                            {
                                [path]: {
                                    [operatorKey]: formattedValue
                                }
                            }
                        ]
                    }
                };
                if (typeof formattedValue === 'string') {
                    if (_mongoose.default.Types.ObjectId.isValid(formattedValue)) {
                        result.value.$or.push({
                            [path]: {
                                [operatorKey]: (0, _bsonobjectid.default)(formattedValue)
                            }
                        });
                    } else {
                        (Array.isArray(field.relationTo) ? field.relationTo : [
                            field.relationTo
                        ]).forEach((relationTo)=>{
                            const isRelatedToCustomNumberID = payload.collections[relationTo]?.config?.fields.find((relatedField)=>{
                                return (0, _types.fieldAffectsData)(relatedField) && relatedField.name === 'id' && relatedField.type === 'number';
                            });
                            if (isRelatedToCustomNumberID) {
                                if (isRelatedToCustomNumberID.type === 'number') hasNumberIDRelation = true;
                            }
                        });
                        if (hasNumberIDRelation) result.value.$or.push({
                            [path]: {
                                [operatorKey]: parseFloat(formattedValue)
                            }
                        });
                    }
                }
                if (result.value.$or.length > 1) {
                    return result;
                }
            }
            if (formattedOperator === 'like' && typeof formattedValue === 'string') {
                const words = formattedValue.split(' ');
                const result = {
                    value: {
                        $and: words.map((word)=>({
                                [path]: {
                                    $options: 'i',
                                    $regex: word.replace(/[\\^$*+?.()|[\]{}]/g, '\\$&')
                                }
                            }))
                    }
                };
                return result;
            }
            // Some operators like 'near' need to define a full query
            // so if there is no operator key, just return the value
            if (!operatorKey) {
                return {
                    path,
                    value: formattedValue
                };
            }
            return {
                path,
                value: {
                    [operatorKey]: formattedValue
                }
            };
        }
    }
    return undefined;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9xdWVyaWVzL2J1aWxkU2VhcmNoUGFyYW1zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgUGF5bG9hZCB9IGZyb20gJ3BheWxvYWQnXG5pbXBvcnQgdHlwZSB7IFBhdGhUb1F1ZXJ5IH0gZnJvbSAncGF5bG9hZC9kYXRhYmFzZSdcbmltcG9ydCB0eXBlIHsgRmllbGQgfSBmcm9tICdwYXlsb2FkL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBPcGVyYXRvciB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5cbmltcG9ydCBvYmplY3RJRCBmcm9tICdic29uLW9iamVjdGlkJ1xuaW1wb3J0IG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJ1xuaW1wb3J0IHsgZ2V0TG9jYWxpemVkUGF0aHMgfSBmcm9tICdwYXlsb2FkL2RhdGFiYXNlJ1xuaW1wb3J0IHsgZmllbGRBZmZlY3RzRGF0YSB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5pbXBvcnQgeyB2YWxpZE9wZXJhdG9ycyB9IGZyb20gJ3BheWxvYWQvdHlwZXMnXG5cbmltcG9ydCB0eXBlIHsgTW9uZ29vc2VBZGFwdGVyIH0gZnJvbSAnLi4nXG5cbmltcG9ydCB7IG9wZXJhdG9yTWFwIH0gZnJvbSAnLi9vcGVyYXRvck1hcCdcbmltcG9ydCB7IHNhbml0aXplUXVlcnlWYWx1ZSB9IGZyb20gJy4vc2FuaXRpemVRdWVyeVZhbHVlJ1xuXG50eXBlIFNlYXJjaFBhcmFtID0ge1xuICBwYXRoPzogc3RyaW5nXG4gIHZhbHVlOiB1bmtub3duXG59XG5cbmNvbnN0IHN1YlF1ZXJ5T3B0aW9ucyA9IHtcbiAgbGVhbjogdHJ1ZSxcbiAgbGltaXQ6IDUwLFxufVxuXG4vKipcbiAqIENvbnZlcnQgdGhlIFBheWxvYWQga2V5IC8gdmFsdWUgLyBvcGVyYXRvciBpbnRvIGEgTW9uZ29EQiBxdWVyeVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYnVpbGRTZWFyY2hQYXJhbSh7XG4gIGNvbGxlY3Rpb25TbHVnLFxuICBmaWVsZHMsXG4gIGdsb2JhbFNsdWcsXG4gIGluY29taW5nUGF0aCxcbiAgbG9jYWxlLFxuICBvcGVyYXRvcixcbiAgcGF5bG9hZCxcbiAgdmFsLFxufToge1xuICBjb2xsZWN0aW9uU2x1Zz86IHN0cmluZ1xuICBmaWVsZHM6IEZpZWxkW11cbiAgZ2xvYmFsU2x1Zz86IHN0cmluZ1xuICBpbmNvbWluZ1BhdGg6IHN0cmluZ1xuICBsb2NhbGU/OiBzdHJpbmdcbiAgb3BlcmF0b3I6IHN0cmluZ1xuICBwYXlsb2FkOiBQYXlsb2FkXG4gIHZhbDogdW5rbm93blxufSk6IFByb21pc2U8U2VhcmNoUGFyYW0+IHtcbiAgLy8gUmVwbGFjZSBHcmFwaFFMIG5lc3RlZCBmaWVsZCBkb3VibGUgdW5kZXJzY29yZSBmb3JtYXR0aW5nXG4gIGxldCBzYW5pdGl6ZWRQYXRoID0gaW5jb21pbmdQYXRoLnJlcGxhY2UoL19fL2csICcuJylcbiAgaWYgKHNhbml0aXplZFBhdGggPT09ICdpZCcpIHNhbml0aXplZFBhdGggPSAnX2lkJ1xuXG4gIGxldCBwYXRoczogUGF0aFRvUXVlcnlbXSA9IFtdXG5cbiAgbGV0IGhhc0N1c3RvbUlEID0gZmFsc2VcblxuICBpZiAoc2FuaXRpemVkUGF0aCA9PT0gJ19pZCcpIHtcbiAgICBjb25zdCBjdXN0b21JRGZpZWxkID0gcGF5bG9hZC5jb2xsZWN0aW9uc1tjb2xsZWN0aW9uU2x1Z10/LmNvbmZpZy5maWVsZHMuZmluZChcbiAgICAgIChmaWVsZCkgPT4gZmllbGRBZmZlY3RzRGF0YShmaWVsZCkgJiYgZmllbGQubmFtZSA9PT0gJ2lkJyxcbiAgICApXG5cbiAgICBsZXQgaWRGaWVsZFR5cGU6ICdudW1iZXInIHwgJ3RleHQnID0gJ3RleHQnXG5cbiAgICBpZiAoY3VzdG9tSURmaWVsZCkge1xuICAgICAgaWYgKGN1c3RvbUlEZmllbGQ/LnR5cGUgPT09ICd0ZXh0JyB8fCBjdXN0b21JRGZpZWxkPy50eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICBpZEZpZWxkVHlwZSA9IGN1c3RvbUlEZmllbGQudHlwZVxuICAgICAgfVxuXG4gICAgICBoYXNDdXN0b21JRCA9IHRydWVcbiAgICB9XG5cbiAgICBwYXRocy5wdXNoKHtcbiAgICAgIGNvbGxlY3Rpb25TbHVnLFxuICAgICAgY29tcGxldGU6IHRydWUsXG4gICAgICBmaWVsZDoge1xuICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICB0eXBlOiBpZEZpZWxkVHlwZSxcbiAgICAgIH0gYXMgRmllbGQsXG4gICAgICBwYXRoOiAnX2lkJyxcbiAgICB9KVxuICB9IGVsc2Uge1xuICAgIHBhdGhzID0gYXdhaXQgZ2V0TG9jYWxpemVkUGF0aHMoe1xuICAgICAgY29sbGVjdGlvblNsdWcsXG4gICAgICBmaWVsZHMsXG4gICAgICBnbG9iYWxTbHVnLFxuICAgICAgaW5jb21pbmdQYXRoOiBzYW5pdGl6ZWRQYXRoLFxuICAgICAgbG9jYWxlLFxuICAgICAgcGF5bG9hZCxcbiAgICB9KVxuICB9XG5cbiAgY29uc3QgW3sgZmllbGQsIHBhdGggfV0gPSBwYXRoc1xuXG4gIGlmIChwYXRoKSB7XG4gICAgY29uc3QgeyBvcGVyYXRvcjogZm9ybWF0dGVkT3BlcmF0b3IsIHZhbDogZm9ybWF0dGVkVmFsdWUgfSA9IHNhbml0aXplUXVlcnlWYWx1ZSh7XG4gICAgICBmaWVsZCxcbiAgICAgIGhhc0N1c3RvbUlELFxuICAgICAgb3BlcmF0b3IsXG4gICAgICBwYXRoLFxuICAgICAgdmFsLFxuICAgIH0pXG5cbiAgICAvLyBJZiB0aGVyZSBhcmUgbXVsdGlwbGUgY29sbGVjdGlvbnMgdG8gc2VhcmNoIHRocm91Z2gsXG4gICAgLy8gUmVjdXJzaXZlbHkgYnVpbGQgdXAgYSBsaXN0IG9mIHF1ZXJ5IGNvbnN0cmFpbnRzXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA+IDEpIHtcbiAgICAgIC8vIFJlbW92ZSB0b3AgY29sbGVjdGlvbiBhbmQgcmV2ZXJzZSBhcnJheVxuICAgICAgLy8gdG8gd29yayBiYWNrd2FyZHMgZnJvbSB0b3BcbiAgICAgIGNvbnN0IHBhdGhzVG9RdWVyeSA9IHBhdGhzLnNsaWNlKDEpLnJldmVyc2UoKVxuXG4gICAgICBjb25zdCBpbml0aWFsUmVsYXRpb25zaGlwUXVlcnkgPSB7XG4gICAgICAgIHZhbHVlOiB7fSxcbiAgICAgIH0gYXMgU2VhcmNoUGFyYW1cblxuICAgICAgY29uc3QgcmVsYXRpb25zaGlwUXVlcnkgPSBhd2FpdCBwYXRoc1RvUXVlcnkucmVkdWNlKFxuICAgICAgICBhc3luYyAocHJpb3JRdWVyeSwgeyBjb2xsZWN0aW9uU2x1Zzogc2x1ZywgcGF0aDogc3ViUGF0aCB9LCBpKSA9PiB7XG4gICAgICAgICAgY29uc3QgcHJpb3JRdWVyeVJlc3VsdCA9IGF3YWl0IHByaW9yUXVlcnlcblxuICAgICAgICAgIGNvbnN0IFN1Yk1vZGVsID0gKHBheWxvYWQuZGIgYXMgTW9uZ29vc2VBZGFwdGVyKS5jb2xsZWN0aW9uc1tzbHVnXVxuXG4gICAgICAgICAgLy8gT24gdGhlIFwiZGVlcGVzdFwiIGNvbGxlY3Rpb24sXG4gICAgICAgICAgLy8gU2VhcmNoIG9uIHRoZSB2YWx1ZSBwYXNzZWQgdGhyb3VnaCB0aGUgcXVlcnlcbiAgICAgICAgICBpZiAoaSA9PT0gMCkge1xuICAgICAgICAgICAgY29uc3Qgc3ViUXVlcnkgPSBhd2FpdCBTdWJNb2RlbC5idWlsZFF1ZXJ5KHtcbiAgICAgICAgICAgICAgbG9jYWxlLFxuICAgICAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgICAgICB3aGVyZToge1xuICAgICAgICAgICAgICAgIFtzdWJQYXRoXToge1xuICAgICAgICAgICAgICAgICAgW2Zvcm1hdHRlZE9wZXJhdG9yXTogdmFsLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBTdWJNb2RlbC5maW5kKHN1YlF1ZXJ5LCBzdWJRdWVyeU9wdGlvbnMpXG5cbiAgICAgICAgICAgIGNvbnN0ICRpbjogdW5rbm93bltdID0gW11cblxuICAgICAgICAgICAgcmVzdWx0LmZvckVhY2goKGRvYykgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBzdHJpbmdJRCA9IGRvYy5faWQudG9TdHJpbmcoKVxuICAgICAgICAgICAgICAkaW4ucHVzaChzdHJpbmdJRClcblxuICAgICAgICAgICAgICBpZiAobW9uZ29vc2UuVHlwZXMuT2JqZWN0SWQuaXNWYWxpZChzdHJpbmdJRCkpIHtcbiAgICAgICAgICAgICAgICAkaW4ucHVzaChkb2MuX2lkKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBpZiAocGF0aHNUb1F1ZXJ5Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHsgJGluIH0sXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgbmV4dFN1YlBhdGggPSBwYXRoc1RvUXVlcnlbaSArIDFdLnBhdGhcblxuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgdmFsdWU6IHsgW25leHRTdWJQYXRoXTogeyAkaW4gfSB9LFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGNvbnN0IHN1YlF1ZXJ5ID0gcHJpb3JRdWVyeVJlc3VsdC52YWx1ZVxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IFN1Yk1vZGVsLmZpbmQoc3ViUXVlcnksIHN1YlF1ZXJ5T3B0aW9ucylcblxuICAgICAgICAgIGNvbnN0ICRpbiA9IHJlc3VsdC5tYXAoKGRvYykgPT4gZG9jLl9pZC50b1N0cmluZygpKVxuXG4gICAgICAgICAgLy8gSWYgaXQgaXMgdGhlIGxhc3QgcmVjdXJzaW9uXG4gICAgICAgICAgLy8gdGhlbiBwYXNzIHRocm91Z2ggdGhlIHNlYXJjaCBwYXJhbVxuICAgICAgICAgIGlmIChpICsgMSA9PT0gcGF0aHNUb1F1ZXJ5Lmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgdmFsdWU6IHsgJGluIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbHVlOiB7XG4gICAgICAgICAgICAgIF9pZDogeyAkaW4gfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBQcm9taXNlLnJlc29sdmUoaW5pdGlhbFJlbGF0aW9uc2hpcFF1ZXJ5KSxcbiAgICAgIClcblxuICAgICAgcmV0dXJuIHJlbGF0aW9uc2hpcFF1ZXJ5XG4gICAgfVxuXG4gICAgaWYgKGZvcm1hdHRlZE9wZXJhdG9yICYmIHZhbGlkT3BlcmF0b3JzLmluY2x1ZGVzKGZvcm1hdHRlZE9wZXJhdG9yIGFzIE9wZXJhdG9yKSkge1xuICAgICAgY29uc3Qgb3BlcmF0b3JLZXkgPSBvcGVyYXRvck1hcFtmb3JtYXR0ZWRPcGVyYXRvcl1cblxuICAgICAgaWYgKGZpZWxkLnR5cGUgPT09ICdyZWxhdGlvbnNoaXAnIHx8IGZpZWxkLnR5cGUgPT09ICd1cGxvYWQnKSB7XG4gICAgICAgIGxldCBoYXNOdW1iZXJJRFJlbGF0aW9uXG5cbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgIHZhbHVlOiB7XG4gICAgICAgICAgICAkb3I6IFt7IFtwYXRoXTogeyBbb3BlcmF0b3JLZXldOiBmb3JtYXR0ZWRWYWx1ZSB9IH1dLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cblxuICAgICAgICBpZiAodHlwZW9mIGZvcm1hdHRlZFZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGlmIChtb25nb29zZS5UeXBlcy5PYmplY3RJZC5pc1ZhbGlkKGZvcm1hdHRlZFZhbHVlKSkge1xuICAgICAgICAgICAgcmVzdWx0LnZhbHVlLiRvci5wdXNoKHsgW3BhdGhdOiB7IFtvcGVyYXRvcktleV06IG9iamVjdElEKGZvcm1hdHRlZFZhbHVlKSB9IH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIDsoQXJyYXkuaXNBcnJheShmaWVsZC5yZWxhdGlvblRvKSA/IGZpZWxkLnJlbGF0aW9uVG8gOiBbZmllbGQucmVsYXRpb25Ub10pLmZvckVhY2goXG4gICAgICAgICAgICAgIChyZWxhdGlvblRvKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgaXNSZWxhdGVkVG9DdXN0b21OdW1iZXJJRCA9IHBheWxvYWQuY29sbGVjdGlvbnNbXG4gICAgICAgICAgICAgICAgICByZWxhdGlvblRvXG4gICAgICAgICAgICAgICAgXT8uY29uZmlnPy5maWVsZHMuZmluZCgocmVsYXRlZEZpZWxkKSA9PiB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICBmaWVsZEFmZmVjdHNEYXRhKHJlbGF0ZWRGaWVsZCkgJiZcbiAgICAgICAgICAgICAgICAgICAgcmVsYXRlZEZpZWxkLm5hbWUgPT09ICdpZCcgJiZcbiAgICAgICAgICAgICAgICAgICAgcmVsYXRlZEZpZWxkLnR5cGUgPT09ICdudW1iZXInXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgICAgIGlmIChpc1JlbGF0ZWRUb0N1c3RvbU51bWJlcklEKSB7XG4gICAgICAgICAgICAgICAgICBpZiAoaXNSZWxhdGVkVG9DdXN0b21OdW1iZXJJRC50eXBlID09PSAnbnVtYmVyJykgaGFzTnVtYmVySURSZWxhdGlvbiA9IHRydWVcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGlmIChoYXNOdW1iZXJJRFJlbGF0aW9uKVxuICAgICAgICAgICAgICByZXN1bHQudmFsdWUuJG9yLnB1c2goeyBbcGF0aF06IHsgW29wZXJhdG9yS2V5XTogcGFyc2VGbG9hdChmb3JtYXR0ZWRWYWx1ZSkgfSB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXN1bHQudmFsdWUuJG9yLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGZvcm1hdHRlZE9wZXJhdG9yID09PSAnbGlrZScgJiYgdHlwZW9mIGZvcm1hdHRlZFZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCB3b3JkcyA9IGZvcm1hdHRlZFZhbHVlLnNwbGl0KCcgJylcblxuICAgICAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICAgICAgdmFsdWU6IHtcbiAgICAgICAgICAgICRhbmQ6IHdvcmRzLm1hcCgod29yZCkgPT4gKHtcbiAgICAgICAgICAgICAgW3BhdGhdOiB7XG4gICAgICAgICAgICAgICAgJG9wdGlvbnM6ICdpJyxcbiAgICAgICAgICAgICAgICAkcmVnZXg6IHdvcmQucmVwbGFjZSgvW1xcXFxeJCorPy4oKXxbXFxde31dL2csICdcXFxcJCYnKSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdFxuICAgICAgfVxuXG4gICAgICAvLyBTb21lIG9wZXJhdG9ycyBsaWtlICduZWFyJyBuZWVkIHRvIGRlZmluZSBhIGZ1bGwgcXVlcnlcbiAgICAgIC8vIHNvIGlmIHRoZXJlIGlzIG5vIG9wZXJhdG9yIGtleSwganVzdCByZXR1cm4gdGhlIHZhbHVlXG4gICAgICBpZiAoIW9wZXJhdG9yS2V5KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgcGF0aCxcbiAgICAgICAgICB2YWx1ZTogZm9ybWF0dGVkVmFsdWUsXG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aCxcbiAgICAgICAgdmFsdWU6IHsgW29wZXJhdG9yS2V5XTogZm9ybWF0dGVkVmFsdWUgfSxcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuIl0sIm5hbWVzIjpbImJ1aWxkU2VhcmNoUGFyYW0iLCJzdWJRdWVyeU9wdGlvbnMiLCJsZWFuIiwibGltaXQiLCJjb2xsZWN0aW9uU2x1ZyIsImZpZWxkcyIsImdsb2JhbFNsdWciLCJpbmNvbWluZ1BhdGgiLCJsb2NhbGUiLCJvcGVyYXRvciIsInBheWxvYWQiLCJ2YWwiLCJzYW5pdGl6ZWRQYXRoIiwicmVwbGFjZSIsInBhdGhzIiwiaGFzQ3VzdG9tSUQiLCJjdXN0b21JRGZpZWxkIiwiY29sbGVjdGlvbnMiLCJjb25maWciLCJmaW5kIiwiZmllbGQiLCJmaWVsZEFmZmVjdHNEYXRhIiwibmFtZSIsImlkRmllbGRUeXBlIiwidHlwZSIsInB1c2giLCJjb21wbGV0ZSIsInBhdGgiLCJnZXRMb2NhbGl6ZWRQYXRocyIsImZvcm1hdHRlZE9wZXJhdG9yIiwiZm9ybWF0dGVkVmFsdWUiLCJzYW5pdGl6ZVF1ZXJ5VmFsdWUiLCJsZW5ndGgiLCJwYXRoc1RvUXVlcnkiLCJzbGljZSIsInJldmVyc2UiLCJpbml0aWFsUmVsYXRpb25zaGlwUXVlcnkiLCJ2YWx1ZSIsInJlbGF0aW9uc2hpcFF1ZXJ5IiwicmVkdWNlIiwicHJpb3JRdWVyeSIsInNsdWciLCJzdWJQYXRoIiwiaSIsInByaW9yUXVlcnlSZXN1bHQiLCJTdWJNb2RlbCIsImRiIiwic3ViUXVlcnkiLCJidWlsZFF1ZXJ5Iiwid2hlcmUiLCJyZXN1bHQiLCIkaW4iLCJmb3JFYWNoIiwiZG9jIiwic3RyaW5nSUQiLCJfaWQiLCJ0b1N0cmluZyIsIm1vbmdvb3NlIiwiVHlwZXMiLCJPYmplY3RJZCIsImlzVmFsaWQiLCJuZXh0U3ViUGF0aCIsIm1hcCIsIlByb21pc2UiLCJyZXNvbHZlIiwidmFsaWRPcGVyYXRvcnMiLCJpbmNsdWRlcyIsIm9wZXJhdG9yS2V5Iiwib3BlcmF0b3JNYXAiLCJoYXNOdW1iZXJJRFJlbGF0aW9uIiwiJG9yIiwib2JqZWN0SUQiLCJBcnJheSIsImlzQXJyYXkiLCJyZWxhdGlvblRvIiwiaXNSZWxhdGVkVG9DdXN0b21OdW1iZXJJRCIsInJlbGF0ZWRGaWVsZCIsInBhcnNlRmxvYXQiLCJ3b3JkcyIsInNwbGl0IiwiJGFuZCIsIndvcmQiLCIkb3B0aW9ucyIsIiRyZWdleCIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7OzsrQkE2QnNCQTs7O2VBQUFBOzs7cUVBeEJEO2lFQUNBOzBCQUNhO3VCQUNEOzZCQUtMO29DQUNPOzs7Ozs7QUFPbkMsTUFBTUMsa0JBQWtCO0lBQ3RCQyxNQUFNO0lBQ05DLE9BQU87QUFDVDtBQUtPLGVBQWVILGlCQUFpQixFQUNyQ0ksY0FBYyxFQUNkQyxNQUFNLEVBQ05DLFVBQVUsRUFDVkMsWUFBWSxFQUNaQyxNQUFNLEVBQ05DLFFBQVEsRUFDUkMsT0FBTyxFQUNQQyxHQUFHLEVBVUo7SUFDQyw0REFBNEQ7SUFDNUQsSUFBSUMsZ0JBQWdCTCxhQUFhTSxPQUFPLENBQUMsT0FBTztJQUNoRCxJQUFJRCxrQkFBa0IsTUFBTUEsZ0JBQWdCO0lBRTVDLElBQUlFLFFBQXVCLEVBQUU7SUFFN0IsSUFBSUMsY0FBYztJQUVsQixJQUFJSCxrQkFBa0IsT0FBTztRQUMzQixNQUFNSSxnQkFBZ0JOLFFBQVFPLFdBQVcsQ0FBQ2IsZUFBZSxFQUFFYyxPQUFPYixPQUFPYyxLQUN2RSxDQUFDQyxRQUFVQyxJQUFBQSx1QkFBZ0IsRUFBQ0QsVUFBVUEsTUFBTUUsSUFBSSxLQUFLO1FBR3ZELElBQUlDLGNBQWlDO1FBRXJDLElBQUlQLGVBQWU7WUFDakIsSUFBSUEsZUFBZVEsU0FBUyxVQUFVUixlQUFlUSxTQUFTLFVBQVU7Z0JBQ3RFRCxjQUFjUCxjQUFjUSxJQUFJO1lBQ2xDO1lBRUFULGNBQWM7UUFDaEI7UUFFQUQsTUFBTVcsSUFBSSxDQUFDO1lBQ1RyQjtZQUNBc0IsVUFBVTtZQUNWTixPQUFPO2dCQUNMRSxNQUFNO2dCQUNORSxNQUFNRDtZQUNSO1lBQ0FJLE1BQU07UUFDUjtJ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